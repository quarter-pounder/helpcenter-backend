name: Deploy

on:
  workflow_call:
    inputs:
      service:
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.HELPCENTER_CICD }}
          create_credentials_file: true
          export_environment_variables: true

      - uses: google-github-actions/setup-gcloud@v2

      - id: env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
          else
            echo "environment=staging" >> $GITHUB_OUTPUT
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure Docker for Artifact Registry
        env:
          GOOGLE_CLOUD_PROJECT: ${{ secrets.GOOGLE_CLOUD_PROJECT }}
          GOOGLE_CLOUD_REGION: ${{ secrets.GOOGLE_CLOUD_REGION }}
        run: |
          PROJECT_ID="${{ secrets.GOOGLE_CLOUD_PROJECT }}"
          REGION="${{ secrets.GOOGLE_CLOUD_REGION }}"
          REPOSITORY="docker-repo"

          # Create Artifact Registry repository if it doesn't exist
          if ! gcloud artifacts repositories describe "${REPOSITORY}" \
            --location="${REGION}" \
            --repository-format=docker 2>/dev/null; then
            echo "Creating Artifact Registry repository: ${REPOSITORY}"
            gcloud artifacts repositories create "${REPOSITORY}" \
              --repository-format=docker \
              --location="${REGION}" \
              --description="Docker repository for HelpCenter services" || true
          fi

          # Configure Docker authentication
          gcloud auth configure-docker "${REGION}-docker.pkg.dev" --quiet

      - name: Build and push Docker image
        id: build
        env:
          GOOGLE_CLOUD_PROJECT: ${{ secrets.GOOGLE_CLOUD_PROJECT }}
          GOOGLE_CLOUD_REGION: ${{ secrets.GOOGLE_CLOUD_REGION }}
        run: |
          PROJECT_ID="${{ secrets.GOOGLE_CLOUD_PROJECT }}"
          REGION="${{ secrets.GOOGLE_CLOUD_REGION }}"
          REPOSITORY="docker-repo"
          ENVIRONMENT="${{ steps.env.outputs.environment }}"
          IMAGE_TAG="${{ github.sha }}"

          if [[ "${{ inputs.service }}" == "graphql_api" ]]; then
            IMAGE_NAME="helpcenter-graphql-api"
            DOCKERFILE="Dockerfile.uv"
          elif [[ "${{ inputs.service }}" == "editor_api" ]]; then
            IMAGE_NAME="helpcenter-editor-api"
            DOCKERFILE="editor_api/Dockerfile.uv"
          else
            echo "Unknown service: ${{ inputs.service }}"
            exit 1
          fi

          IMAGE_URI="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPOSITORY}/${IMAGE_NAME}"
          SERVICE_NAME="${IMAGE_NAME}-${ENVIRONMENT}"

          echo "Building Docker image: ${IMAGE_URI}:${IMAGE_TAG}"
          docker build \
            -f "${DOCKERFILE}" \
            -t "${IMAGE_URI}:${IMAGE_TAG}" \
            -t "${IMAGE_URI}:latest" \
            --build-arg ENVIRONMENT="${ENVIRONMENT}" \
            .

          echo "Pushing Docker image..."
          docker push "${IMAGE_URI}:${IMAGE_TAG}"
          docker push "${IMAGE_URI}:latest"

          echo "image_uri=${IMAGE_URI}:${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "service_name=${SERVICE_NAME}" >> $GITHUB_OUTPUT

      - name: Validate required secrets
        env:
          NEON_DB_CONNECTION_STRING: ${{ secrets.NEON_DB_CONNECTION_STRING }}
          NEON_DB_HOST: ${{ secrets.NEON_DB_HOST }}
          NEON_DB_NAME: ${{ secrets.NEON_DB_NAME }}
          NEON_DB_USER: ${{ secrets.NEON_DB_USER }}
          NEON_DB_PASSWORD: ${{ secrets.NEON_DB_PASSWORD }}
        run: |
          if [ -n "$NEON_DB_HOST" ] && [ -n "$NEON_DB_NAME" ] && [ -n "$NEON_DB_USER" ] && [ -n "$NEON_DB_PASSWORD" ]; then
            echo "Using individual Neon DB variables"
            echo "NEON_DB_HOST is set"
            echo "NEON_DB_NAME is set"
            echo "NEON_DB_USER is set"
            echo "NEON_DB_PASSWORD is set (length: ${#NEON_DB_PASSWORD})"
          elif [ -n "$NEON_DB_CONNECTION_STRING" ]; then
            echo "Using NEON_DB_CONNECTION_STRING (length: ${#NEON_DB_CONNECTION_STRING})"
          else
            echo "ERROR: Either NEON_DB_CONNECTION_STRING or all of NEON_DB_HOST, NEON_DB_NAME, NEON_DB_USER, NEON_DB_PASSWORD must be set"
            exit 1
          fi

      - name: Setup UV for migrations
        if: inputs.service == 'graphql_api'
        uses: ./.github/actions/setup-uv

      - name: Run database migrations
        if: inputs.service == 'graphql_api'
        env:
          NEON_DB_CONNECTION_STRING: ${{ secrets.NEON_DB_CONNECTION_STRING }}
          NEON_DB_HOST: ${{ secrets.NEON_DB_HOST }}
          NEON_DB_NAME: ${{ secrets.NEON_DB_NAME }}
          NEON_DB_USER: ${{ secrets.NEON_DB_USER }}
          NEON_DB_PASSWORD: ${{ secrets.NEON_DB_PASSWORD }}
          NEON_DB_PORT: ${{ secrets.NEON_DB_PORT }}
          ENVIRONMENT: ${{ steps.env.outputs.environment }}
        run: |
          python3 << 'PYTHON_EOF'
          import os
          import subprocess
          import sys
          from urllib.parse import quote_plus

          neon_host = os.environ.get('NEON_DB_HOST')
          neon_name = os.environ.get('NEON_DB_NAME')
          neon_user = os.environ.get('NEON_DB_USER')
          neon_password = os.environ.get('NEON_DB_PASSWORD')
          neon_port = os.environ.get('NEON_DB_PORT', '5432')
          neon_conn = os.environ.get('NEON_DB_CONNECTION_STRING')

          if neon_host and neon_name and neon_user and neon_password:
              encoded_password = quote_plus(neon_password)
              db_url = f"postgresql+asyncpg://{neon_user}:{encoded_password}@{neon_host}:{neon_port}/{neon_name}"
              print("Using individual Neon DB variables for migration")
          elif neon_conn:
              db_url = neon_conn
              if db_url.startswith("postgresql://"):
                  db_url = db_url.replace("postgresql://", "postgresql+asyncpg://", 1)
              print("Using NEON_DB_CONNECTION_STRING for migration")
          else:
              print("ERROR: No database connection configured")
              sys.exit(1)

          os.environ['NEON_DB_CONNECTION_STRING'] = db_url
          os.environ['ENVIRONMENT'] = os.environ.get('ENVIRONMENT', 'prod')

          print("Running migrations...")
          result = subprocess.run(
              ['uv', 'run', 'python', '-m', 'alembic', '-c', 'graphql_api/alembic.ini', 'upgrade', 'head'],
              cwd='.',
              capture_output=True,
              text=True
          )

          if result.returncode != 0:
              print("Migration failed:")
              print(f"STDOUT: {result.stdout}")
              print(f"STDERR: {result.stderr}")
              sys.exit(1)
          else:
              print("Migrations completed successfully")
              if result.stdout:
                  print(result.stdout)
          PYTHON_EOF

      - name: Deploy to Cloud Run
        env:
          GOOGLE_CLOUD_PROJECT: ${{ secrets.GOOGLE_CLOUD_PROJECT }}
          GOOGLE_CLOUD_REGION: ${{ secrets.GOOGLE_CLOUD_REGION }}
          NEON_DB_CONNECTION_STRING: ${{ secrets.NEON_DB_CONNECTION_STRING }}
          NEON_DB_HOST: ${{ secrets.NEON_DB_HOST }}
          NEON_DB_NAME: ${{ secrets.NEON_DB_NAME }}
          NEON_DB_USER: ${{ secrets.NEON_DB_USER }}
          NEON_DB_PASSWORD: ${{ secrets.NEON_DB_PASSWORD }}
          NEON_DB_PORT: ${{ secrets.NEON_DB_PORT }}
          REDIS_URL: ${{ secrets.REDIS_URL }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          DEV_EDITOR_KEY: ${{ secrets.DEV_EDITOR_KEY }}
          GCS_BUCKET_NAME: ${{ secrets.GCS_BUCKET_NAME }}
          HELPCENTER_GCS: ${{ secrets.HELPCENTER_GCS }}
          ALLOWED_ORIGINS: ${{ secrets.ALLOWED_ORIGINS }}
        run: |
          PROJECT_ID="${{ secrets.GOOGLE_CLOUD_PROJECT }}"
          REGION="${{ secrets.GOOGLE_CLOUD_REGION }}"
          ENVIRONMENT="${{ steps.env.outputs.environment }}"
          SERVICE_NAME="${{ steps.build.outputs.service_name }}"
          IMAGE_URI="${{ steps.build.outputs.image_uri }}"

          python3 << 'PYTHON_EOF'
          import yaml
          import os

          env_vars = {
              'ENVIRONMENT': os.environ.get('ENVIRONMENT', ''),
              'REDIS_URL': os.environ.get('REDIS_URL', ''),
              'SECRET_KEY': os.environ.get('SECRET_KEY', ''),
              'DEV_EDITOR_KEY': os.environ.get('DEV_EDITOR_KEY', ''),
              'GCS_BUCKET_NAME': os.environ.get('GCS_BUCKET_NAME', ''),
              'HELPCENTER_GCS': os.environ.get('HELPCENTER_GCS', ''),
              'ALLOWED_ORIGINS': os.environ.get('ALLOWED_ORIGINS', ''),
          }

          neon_host = os.environ.get('NEON_DB_HOST')
          neon_name = os.environ.get('NEON_DB_NAME')
          neon_user = os.environ.get('NEON_DB_USER')
          neon_password = os.environ.get('NEON_DB_PASSWORD')
          neon_port = os.environ.get('NEON_DB_PORT', '5432')

          if neon_host and neon_name and neon_user and neon_password:
              env_vars['NEON_DB_HOST'] = neon_host
              env_vars['NEON_DB_NAME'] = neon_name
              env_vars['NEON_DB_USER'] = neon_user
              env_vars['NEON_DB_PASSWORD'] = neon_password
              env_vars['NEON_DB_PORT'] = neon_port
              print("Using individual Neon DB variables")
          elif os.environ.get('NEON_DB_CONNECTION_STRING'):
              env_vars['NEON_DB_CONNECTION_STRING'] = os.environ.get('NEON_DB_CONNECTION_STRING')
              print("Using NEON_DB_CONNECTION_STRING")
          else:
              raise ValueError(
                  "Either NEON_DB_CONNECTION_STRING or all of "
                  "NEON_DB_HOST, NEON_DB_NAME, NEON_DB_USER, NEON_DB_PASSWORD must be set"
              )

          with open('/tmp/env-vars.yaml', 'w') as f:
              yaml.dump(env_vars, f, default_flow_style=False, allow_unicode=True)
          PYTHON_EOF

          # First, clear Cloud SQL connections if they exist
          echo "Clearing any existing Cloud SQL connections..."
          gcloud run services update "${SERVICE_NAME}" \
            --region="${REGION}" \
            --clear-cloudsql-instances \
            2>/dev/null || echo "No Cloud SQL connections to clear or service doesn't exist yet"

          # Deploy the service
          gcloud run deploy "${SERVICE_NAME}" \
            --image "${IMAGE_URI}" \
            --platform managed \
            --region "${REGION}" \
            --allow-unauthenticated \
            --service-account=helpcenter-runtime@${PROJECT_ID}.iam.gserviceaccount.com \
            --env-vars-file=/tmp/env-vars.yaml \
            --clear-cloudsql-instances \
            --memory 1Gi \
            --cpu 1 \
            --min-instances 0 \
            --max-instances 10 \
            --timeout 300 \
            --concurrency 100

          echo "Verifying deployment configuration..."
          CLOUDSQL=$(gcloud run services describe "${SERVICE_NAME}" \
            --region="${REGION}" \
            --format="value(spec.template.spec.containers[0].cloudSqlInstances)" 2>/dev/null || echo "")

          if [ -n "$CLOUDSQL" ] && [ "$CLOUDSQL" != "" ]; then
            echo "WARNING: Cloud SQL instances are still configured: $CLOUDSQL"
          else
            echo "✓ Cloud SQL connections cleared"
          fi

          NEON_HOST_CHECK=$(gcloud run services describe "${SERVICE_NAME}" \
            --region="${REGION}" \
            --format="value(spec.template.spec.containers[0].env.NEON_DB_HOST)" 2>/dev/null || echo "")
          NEON_CONN_CHECK=$(gcloud run services describe "${SERVICE_NAME}" \
            --region="${REGION}" \
            --format="value(spec.template.spec.containers[0].env.NEON_DB_CONNECTION_STRING)" 2>/dev/null || echo "")

          if [ -n "$NEON_HOST_CHECK" ]; then
            echo "✓ Individual Neon DB variables are set"
          elif [ -n "$NEON_CONN_CHECK" ]; then
            echo "✓ NEON_DB_CONNECTION_STRING is set"
          else
            echo "WARNING: Neon DB configuration might not be set"
          fi

          rm -f /tmp/env-vars.yaml

      - name: Output deployed URL
        run: |
          SERVICE="helpcenter-${{ inputs.service }}-${{ steps.env.outputs.environment }}"
          URL=$(gcloud run services describe "$SERVICE" \
            --region="${{ secrets.GOOGLE_CLOUD_REGION }}" \
            --format="value(status.url)" || true)
          echo "Deployed URL: ${URL:-<not found>}"
